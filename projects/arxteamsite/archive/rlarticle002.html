<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
<head>
    <link href="default.css" rel="stylesheet" type="text/css">
	<style>
	<!--
	FONT {
	FONT-SIZE: 9.5pt;
	FONT-FAMILY: "Courier New", Courier, monospace;
	-->
	</style>
	<META http-equiv=Content-Type content="text/html; charset=windows-1251">
    <script language=JavaScript src="engine.js"></script>
    <script language=JavaScript>
    <!--
    menu("Roguelike Development");
    //--></script>
<font color="BBBBBB" class="def">
<div align="center"><h1>Roguelike Development.</h1>
<h2>Методы генерации лабиринтов</h2>
</div>
</font>
<font color="BBBBBB" class="Article">
Существует несколько алгоритмов генерации лабиринтов, но все они эксплуатируют одну и ту же идею: лабиринт - множество связанных
коридоров. Это утверждение подсказывает довольно простой алгоритм решения нащей проблемы - генерации лабиринта. Мы будем 
строить его коридорами! Алгоритм таков:<br>
Шаг 0. Выбираем начало лабиринта.<br>
Шаг 1. Из выбранной клетки тянем случайный коридор следующим образом: сначала выбираем, куда из текущей клетки можно построить
кусочек коридора длиной 1, 2 или 3, и потом строим случайно выбранный кусочек из возможных. Критерий возможности постройки
кусочка коридора: он не касается уже построенной части. Повторяем процесс до тех пор, пока длина построенной "кишки" не 
превысит определенного значения или пока коридор не упрется сам в себя.<br>
Шаг 2. Выбираем на уже построенном участке лабиринта новое начало.<br>
Шаг 3. Если лабиринт еще не построен, то переходим к шагу 1.<br>
<br>
Пример работы алгоритма:<br>

Шаг 0.<br>
Случайно выбираем начало
<pre>
<font color="#808080">###############
###############
###############
###############
###############
###############
#####</font><font color="#ffff00">X</font><font color="#808080">#########</font> <font color="#ffff00">X</font> - начало
<font color="#808080">############### #</font> - стена
<font color="#808080">###############
###############
###############
###############
###############</font>
</pre>

Шаг 1.1<br>
Путем нехитрых вычислений получаем, что из выбранной клетки можно провести все 12 типов тонеллей (длинами 1, 2 и 3 во все
4 стороны). Пусть нам выпало копать тоннель длиной 2 на юг.<br>
<pre>
<font color="#808080">###############
###############
###############
###############
###############
###############
#####</font><font color="#ffff00">X</font><font color="#808080">#########</font> <font color="#ffff00">X</font> - начало
<font color="#808080">#####</font>.<font color="#808080">######### #</font> - стена
<font color="#808080">#####</font>.<font color="#808080">#########</font> . - пол
<font color="#808080">###############
###############
###############
###############</font>
</pre>

Шаг 1.2<br>
Продолжаем копать наш тоннель, пока он не упрется сам в себя.<br>
<pre>
<font color="#808080">###############
###</font>....<font color="#808080">########
#</font>...<font color="#808080">##</font>...<font color="#808080">######
#</font>.<font color="#808080">######</font>.<font color="#808080">######
#</font>......<font color="#808080">#</font>...<font color="#808080">####
##########</font>.<font color="#808080">####
#####</font><font color="#ffff00">X</font><font color="#808080">####</font>.<font color="#808080">####</font> <font color="#ffff00">X</font> - начало
<font color="#808080">#####</font>.<font color="#808080">##</font>...<font color="#808080">#### #</font> - стена
<font color="#808080">#####</font>....<font color="#808080">######</font> . - пол
<font color="#808080">###############
###############
###############
###############</font>
</pre>

Шаг 2<br>
Выбираем на уже построенной части лабиринта новое начало.<br>
<pre>
<font color="#808080">###############
###</font>....<font color="#808080">########
#</font>...<font color="#808080">##</font>...<font color="#808080">######
#</font>.<font color="#808080">######</font>.<font color="#808080">######
#</font>.<font color="#ffff00">X</font>....<font color="#808080">#</font>...<font color="#808080">####
##########</font>.<font color="#808080">####
#####</font>.<font color="#808080">####</font>.<font color="#808080">####</font> <font color="#ffff00">X</font> - новое начало
<font color="#808080">#####</font>.<font color="#808080">##</font>...<font color="#808080">#### #</font> - стена
<font color="#808080">#####</font>....<font color="#808080">######</font> . - пол
<font color="#808080">###############
###############
###############
###############</font>
</pre>

Шаг 3.<br>
Лабиринт пока маловат, поэтому идем обратно на шаг 1.<br>
<br>
Шаг 1.<br>
Опять тянем тоннель.<br>
<pre>
<font color="#808080">###############
###</font>....<font color="#808080">###</font>.<font color="#808080">####
#</font>...<font color="#808080">##</font>...<font color="#808080">#</font>...<font color="#808080">##
#</font>.<font color="#808080">######</font>.<font color="#808080">###</font>..<font color="#808080">#
#</font>.<font color="#ffff00">X</font>....<font color="#808080">#</font>...<font color="#808080">##</font>.<font color="#808080">#
##</font>.<font color="#808080">#######</font>.<font color="#808080">##</font>.<font color="#808080">#
##</font>..<font color="#808080">#</font>.<font color="#808080">####</font>.<font color="#808080">##</font>.<font color="#808080">#</font> <font color="#ffff00">X</font> - начало
<font color="#808080">###</font>.<font color="#808080">#</font>.<font color="#808080">##</font>...<font color="#808080">#</font>..<font color="#808080"># #</font> - стена
<font color="#808080">###</font>.<font color="#808080">#</font>....<font color="#808080">###</font>.<font color="#808080">##</font> . - пол
<font color="#808080">###</font>.<font color="#808080">########</font>..<font color="#808080">#
###</font>...<font color="#808080">#</font>....<font color="#808080">##</font>.<font color="#808080">#
#####</font>...<font color="#808080">##</font>....<font color="#808080">#
###############</font>
</pre>

Ну и так далее...<br>
<br>
А теперь немного подробнее остановимся на некоторых мелких, но от того не менее важных деталях.<br>
1. Тянуть прямой участок тоннеля из текущей клетки можно по-разному. Экспериментируя с различными способами реализации этого 
довольно маленького кусочка алгоритма, вы будете получать совершенно различные лабиринты, не похожие друг на друга своей
структурой. Я предложу три метода:<br>
Первый. Тянуть кусок длиной 2 в одном из направлений. При этом лабиринт получается очень красивым и правильным - таким, какие
вы в детстве рисовали на бумаге. Только минотавров внутри не хватает :-). Пример:<br>
<pre>
<font color="#808080">###############
#</font>...<font color="#808080">#</font>...<font color="#808080">#</font>...<font color="#808080">#</font>.<font color="#808080">#
#</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#
#</font>.<font color="#808080">#</font>...<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#</font>...<font color="#808080">#
#</font>.<font color="#808080">#</font>.<font color="#808080">###</font>.<font color="#808080">#</font>.<font color="#808080">#####
#</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.....<font color="#808080">#
###</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">###</font>.<font color="#808080">#</font>.<font color="#808080">#
#</font>...<font color="#808080">#</font>.....<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#
#</font>.<font color="#808080">#####</font>.<font color="#808080">#</font>.<font color="#808080">###</font>.<font color="#808080">#
#</font>...<font color="#808080">#</font>...<font color="#808080">#</font>...<font color="#808080">#</font>.<font color="#808080">#
###</font>.<font color="#808080">#</font>.<font color="#808080">#####</font>.<font color="#808080">#</font>.<font color="#808080">#
#</font>...<font color="#808080">#</font>.....<font color="#808080">#</font>...<font color="#808080">#
###############</font>
</pre>
Второй. Тянуть кусок длиной 1, 2 или 3 (или 4, или 5, или...). Результат вы видели выше. Подходит для строительства лабиринтов с
нерегулярной структурой (например подземелий гоблинов из клана бешеных гробокопателей :-).<br>
<br>
Третий. Вычислить для каждого из направлений возможную максимальную длину прямого тоннеля, после чего взять случайное направление
(с приоритетом на то, в котором можно построить наиболее длинный тоннель). После этого постоить в полученном направлении тоннель
случайной длины. Причем можно ввести квадратичное распределение случайных чисел (что-то типа 
<nobr>Length=Round(MaxLength-Sqrt(Random(Sqr(MaxLength)))+1)</nobr>,где sqr - возведения в квадрат, sqrt - извлечение квадратного 
корня), чтобы чаще строились короткие, или, наоборот, длинные тонелли. Пример:<br>
<pre>
<font color="#808080">###############
#</font>.<font color="#808080">##</font>.<font color="#808080">##</font>.<font color="#808080">##</font>.<font color="#808080">##</font>.<font color="#808080">#
#</font>.<font color="#808080">#</font>.........<font color="#808080">#</font>.<font color="#808080">#
#</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">##</font>.<font color="#808080">##</font>.<font color="#808080">#</font>.<font color="#808080">#
#</font>.<font color="#808080">#</font>.<font color="#808080">####</font>.<font color="#808080">##</font>.<font color="#808080">#</font>.<font color="#808080">#
#</font>.<font color="#808080">#</font>.<font color="#808080">##</font>.<font color="#808080">#</font>..<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#
#</font>.<font color="#808080">#</font>..<font color="#808080">#</font>.<font color="#808080">##</font>.<font color="#808080">#</font>...<font color="#808080">#
#</font>.<font color="#808080">#</font>.<font color="#808080">##</font>.<font color="#808080">##</font>.<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#
#</font>.<font color="#808080">#</font>.<font color="#808080">##</font>.<font color="#808080">#</font>..<font color="#808080">#</font>.<font color="#808080">#</font>.<font color="#808080">#
#</font>.<font color="#808080">#</font>..<font color="#808080">#</font>.<font color="#808080">####</font>.<font color="#808080">#</font>.<font color="#808080">#
#</font>.<font color="#808080">##</font>.<font color="#808080">#</font>......<font color="#808080">#</font>.<font color="#808080">#
#</font>....<font color="#808080">##</font>.<font color="#808080">##</font>.<font color="#808080">##</font>.<font color="#808080">#
###############</font>
</pre>
<br>
2. Хорошим вопросом будет следующий: "А как определить, что рытье тоннелей пора прекратить?". И действительно, когда
прекращать работу алгоритма? Это, опять же, зависит от того, что вы хотите получить, и от используемого способа построения 
прямых участков. Если ваша карта ограничена, то имеет смысл заканчивать работу тогда, когда вся карта будет заполнена, то
есть нельзя будет выбрать такое "начало", из которого можно будет протянуть тоннель. И, второй вариант - выходить тогда,
когда площадь уже построенного лабиринта (его "пола") превысит некоторое значение. При этом следует учесть, что если вы
пользуетесь первым или третьим способом построения прямых участков, то довольно сложно будет вычислить верхний порог
площади, после достижения которого будет существовать лабиринт, который будет невозможно нарастить, и который будет 
иметь прощадь, меньшую необходимой для выхода. В этом случае все повиснет, а юзер, тестящий ваш рогалик, будет
долго поминать вас самыми нехорошими из известных ему слов. То есть нужно комбинировать эти два способа. Вопросов с реализацией
второго, я надеюсь, нет. С первым все не так просто, ведь проверять все поле каждый шаг алгоритма очень ресурсоемко. 
Но есть изящный спобоб решить эту назойливую проблему. Мы просто заведем цикл построчного сканирования поля, в котором
проверяем, можно ли в текущей клетке разместить "начало". Если можно - то тянем из него тоннель, и продолжаем сканирование
до тех пор, пока не просканируем все поле. К этому моменту мы сможем точно сказать, что все поле заполнено лабиринтом.<br>
<br>
И еще несколько штрихов к уже почти законченной картине алгоритма:<br>
Если вы генерите лабиринт на каком-то участке бесконечного поля, то имеет смысл выбирать на некотором малом его участке 
"начала" построчным методом, но не ограничивать выход тоннелей за этот промежуток, а ограничить их длину. Получится красиво и
со вкусом.<br>
"Начала" имеет смысл выбирать не на "полу", а на клетках, граничащих с ним. Это упростит процедуру проверки возможности
создания тонелля из этого "начала".<br>
<br>
<br>
Это все, на большее меня не хватило. Из-за того, что писал эту статью я поздно вечером, возможны опечатки.<br>
<br>
Автор статьи: Фокин Александр aka [ArX]Elric!<br>
e-mail: <a href="mailto:elric2002@mail.ru">elric2002@mail.ru</a><br>
Сайт:<script language=JavaScript>
<!--
homesite();
//--></script><br>
Этот материал распространяется свободно. See the Free Software Foundation's GNU General Public License Version 2 for 
details.<br>


</font>
    <script language=JavaScript>
    <!--
    endmenu();
    //--></script>
</body>
</html>